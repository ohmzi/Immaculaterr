name: Policy: develop-only into master

on:
  push:
    branches:
      - '**'
    tags-ignore:
      - '**'
  pull_request:
    branches:
      - master
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
      - edited

permissions:
  contents: read
  statuses: write

jobs:
  develop-only:
    name: develop-only
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate policy
        id: policy
        shell: bash
        run: |
          set -euo pipefail

          EVENT="${{ github.event_name }}"

          BASE_REF=""
          HEAD_REF=""
          SHA=""

          if [[ "${EVENT}" == "pull_request" ]]; then
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            HEAD_REF="${{ github.event.pull_request.head.ref }}"
            SHA="${{ github.event.pull_request.head.sha }}"
          else
            HEAD_REF="${{ github.ref_name }}"
            SHA="${{ github.sha }}"
          fi

          echo "event=${EVENT}"
          echo "base_ref=${BASE_REF}"
          echo "head_ref=${HEAD_REF}"
          echo "sha=${SHA}"

          allowed="false"
          reason="Only develop is allowed to merge into master."

          # Push events: mark develop as allowed (and master as allowed to avoid noisy red checks).
          if [[ "${EVENT}" == "push" ]]; then
            if [[ "${HEAD_REF}" == "develop" ]]; then
              allowed="true"
              reason="OK: commit is on develop."
            elif [[ "${HEAD_REF}" == "master" ]]; then
              allowed="true"
              reason="OK: commit is on master."
            else
              allowed="false"
              reason="Not allowed: only develop may merge into master."
            fi
          fi

          # PR events: enforce develop -> master only.
          if [[ "${EVENT}" == "pull_request" ]]; then
            if [[ "${BASE_REF}" == "master" && "${HEAD_REF}" == "develop" ]]; then
              allowed="true"
              reason="OK: PR source branch is develop."
            else
              allowed="false"
              reason="Only PRs from develop are allowed into master."
            fi
          fi

          echo "allowed=${allowed}" >> "${GITHUB_OUTPUT}"
          echo "reason=${reason}" >> "${GITHUB_OUTPUT}"
          echo "sha=${SHA}" >> "${GITHUB_OUTPUT}"

      - name: Set required commit status
        if: ${{ always() }}
        uses: actions/github-script@v7
        env:
          SHA: ${{ steps.policy.outputs.sha }}
          ALLOWED: ${{ steps.policy.outputs.allowed }}
          REASON: ${{ steps.policy.outputs.reason }}
        with:
          script: |
            const sha = (process.env.SHA ?? '').trim()
            const allowed = (process.env.ALLOWED ?? '') === 'true'
            const reason = String(process.env.REASON ?? '').trim() || 'Policy check'
            if (!sha) {
              core.warning('No SHA resolved for commit status; skipping.')
              return
            }
            const state = allowed ? 'success' : 'failure'
            const description = reason.slice(0, 140)
            const target_url = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha,
              state,
              context: 'policy/develop-only-into-master',
              description,
              target_url,
            })

      - name: Enforce policy (PRs into master)
        if: ${{ github.event_name == 'pull_request' && steps.policy.outputs.allowed != 'true' }}
        shell: bash
        run: |
          echo "${{ steps.policy.outputs.reason }}"
          exit 1

