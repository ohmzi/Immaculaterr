name: Publish containers (GHCR + Docker Hub)

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
      - edited
      - closed
  workflow_dispatch: {}

permissions:
  contents: write
  packages: write

concurrency:
  # NOTE: Must be a single expression; string concatenation like ${{ a }}-${{ b }} breaks workflow parsing.
  group: ${{ format('{0}-{1}', github.workflow, github.ref) }}
  cancel-in-progress: false

jobs:
  pr-build-check:
    name: PR docker build check
    if: ${{ github.event_name == 'pull_request' && github.event.action != 'closed' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute build metadata
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(
            node -e "const fs=require('fs');const s=fs.readFileSync('apps/api/src/version.ts','utf8');const m=s.match(/APP_VERSION\\s*=\\s*'([^']+)'/);process.stdout.write((m&&m[1]?m[1].trim():'')||'0.0.0.0')"
          )"
          BUILD_TIME="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          {
            echo "version=${VERSION}"
            echo "build_time=${BUILD_TIME}"
          } >> "${GITHUB_OUTPUT}"

      - name: Build container (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/immaculaterr/Dockerfile
          pull: true
          push: false
          platforms: linux/amd64,linux/arm64
          outputs: type=cacheonly
          labels: |
            org.opencontainers.image.title=Immaculaterr
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.event.pull_request.head.sha }}
            org.opencontainers.image.version=${{ steps.vars.outputs.version }}
            org.opencontainers.image.created=${{ steps.vars.outputs.build_time }}
          build-args: |
            APP_VERSION=${{ steps.vars.outputs.version }}
            APP_BUILD_SHA=${{ github.event.pull_request.head.sha }}
            APP_BUILD_TIME=${{ steps.vars.outputs.build_time }}

  build-and-push:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'develop' && github.event.pull_request.base.ref == 'master' }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.vars.outputs.version }}
      ghcr_image: ${{ steps.vars.outputs.ghcr_image }}
      dockerhub_image: ${{ steps.vars.outputs.dockerhub_image }}
      build_time: ${{ steps.vars.outputs.build_time }}
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub (optional)
        if: ${{ env.DOCKERHUB_TOKEN != '' && env.DOCKERHUB_USERNAME != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Compute tags
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          VERSION="$(
            node -e "const fs=require('fs');const s=fs.readFileSync('apps/api/src/version.ts','utf8');const m=s.match(/APP_VERSION\\s*=\\s*'([^']+)'/);process.stdout.write((m&&m[1]?m[1].trim():'')||'0.0.0.0')"
          )"

          OWNER_LC="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          GHCR_IMAGE="ghcr.io/${OWNER_LC}/immaculaterr"
          DOCKERHUB_IMAGE="docker.io/ohmzii/immaculaterr"
          BUILD_TIME="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

          {
            echo "version=${VERSION}"
            echo "ghcr_image=${GHCR_IMAGE}"
            echo "dockerhub_image=${DOCKERHUB_IMAGE}"
            echo "build_time=${BUILD_TIME}"

            echo "tags<<EOF"
            echo "${GHCR_IMAGE}:latest"
            echo "${GHCR_IMAGE}:${VERSION}"
            echo "${GHCR_IMAGE}:v${VERSION}"
            if [[ -n "${DOCKERHUB_TOKEN:-}" && -n "${DOCKERHUB_USERNAME:-}" ]]; then
              echo "${DOCKERHUB_IMAGE}:latest"
              echo "${DOCKERHUB_IMAGE}:v${VERSION}"
            fi
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"
        env:
          DOCKERHUB_USERNAME: ${{ env.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ env.DOCKERHUB_TOKEN }}

      - name: Build and push (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/immaculaterr/Dockerfile
          pull: true
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.vars.outputs.tags }}
          labels: |
            org.opencontainers.image.title=Immaculaterr
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.event.pull_request.merge_commit_sha }}
            org.opencontainers.image.version=${{ steps.vars.outputs.version }}
            org.opencontainers.image.created=${{ steps.vars.outputs.build_time }}
          build-args: |
            APP_VERSION=${{ steps.vars.outputs.version }}
            APP_BUILD_SHA=${{ github.event.pull_request.merge_commit_sha }}
            APP_BUILD_TIME=${{ steps.vars.outputs.build_time }}

  create-release:
    name: Create GitHub release
    needs:
      - build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Prepare release notes (custom format)
        shell: bash
        env:
          VERSION: ${{ needs.build-and-push.outputs.version }}
          GHCR_IMAGE: ${{ needs.build-and-push.outputs.ghcr_image }}
          DOCKERHUB_IMAGE: ${{ needs.build-and-push.outputs.dockerhub_image }}
          BUILD_TIME: ${{ needs.build-and-push.outputs.build_time }}
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
        run: |
          set -euo pipefail
          cat > RELEASE_NOTES.md <<EOF
          ## Release v${VERSION}

          Docker images are published from \`master\` after merge from \`develop\`.

          - GHCR: \`${GHCR_IMAGE}:v${VERSION}\`
          - GHCR (rolling): \`${GHCR_IMAGE}:latest\`
          - Docker Hub (rolling): \`${DOCKERHUB_IMAGE}:latest\`
          - Published at (UTC): \`${BUILD_TIME}\`
          - Commit: \`${MERGE_SHA}\`

          ## Updating

          ### Docker

          \`\`\`bash
          docker pull ohmzii/immaculaterr:latest

          docker rm -f Immaculaterr 2>/dev/null || true

          docker run -d \
            --name Immaculaterr \
            --network host \
            -e HOST=0.0.0.0 \
            -e PORT=5454 \
            -e APP_DATA_DIR=/data \
            -e DATABASE_URL=file:/data/tcp.sqlite \
            -v immaculaterr-data:/data \
            --restart unless-stopped \
            ohmzii/immaculaterr:latest
          \`\`\`

          ### Portainer

          1. In Portainer: **Containers** -> select **Immaculaterr**
          2. Click **Recreate**
          3. Enable **Re-pull image**
          4. Click **Recreate**
          EOF

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build-and-push.outputs.version }}
          target_commitish: ${{ github.event.pull_request.merge_commit_sha }}
          name: Release v${{ needs.build-and-push.outputs.version }}
          body_path: RELEASE_NOTES.md
          generate_release_notes: false
          make_latest: true

