name: Publish containers (GHCR + Docker Hub)

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
      - edited
      - closed
  workflow_dispatch: {}

permissions:
  contents: write
  packages: write

concurrency:
  # NOTE: Must be a single expression; string concatenation like ${{ a }}-${{ b }} breaks workflow parsing.
  group: ${{ format('{0}-{1}', github.workflow, github.ref) }}
  cancel-in-progress: false

jobs:
  pr-build-check:
    name: PR docker build check
    if: ${{ github.event_name == 'pull_request' && github.event.action != 'closed' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Validate Docker Hub HTTP+HTTPS stack compose file
        shell: bash
        run: |
          set -euo pipefail
          IMM_IMAGE=ohmzii/immaculaterr IMM_TAG=latest \
            docker compose -f docker/immaculaterr/docker-compose.dockerhub.yml config >/dev/null

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute build metadata
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(
            node -e "const fs=require('fs');const s=fs.readFileSync('apps/api/src/version.ts','utf8');const m=s.match(/APP_VERSION\\s*=\\s*'([^']+)'/);process.stdout.write((m&&m[1]?m[1].trim():'')||'0.0.0.0')"
          )"
          BUILD_TIME="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          {
            echo "version=${VERSION}"
            echo "build_time=${BUILD_TIME}"
          } >> "${GITHUB_OUTPUT}"

      - name: Build container (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/immaculaterr/Dockerfile
          pull: true
          push: false
          platforms: linux/amd64,linux/arm64
          outputs: type=cacheonly
          labels: |
            org.opencontainers.image.title=Immaculaterr
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.event.pull_request.head.sha }}
            org.opencontainers.image.version=${{ steps.vars.outputs.version }}
            org.opencontainers.image.created=${{ steps.vars.outputs.build_time }}
          build-args: |
            APP_VERSION=${{ steps.vars.outputs.version }}
            APP_BUILD_SHA=${{ github.event.pull_request.head.sha }}
            APP_BUILD_TIME=${{ steps.vars.outputs.build_time }}

  build-and-push:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'develop' && github.event.pull_request.base.ref == 'master' }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.vars.outputs.version }}
      ghcr_image: ${{ steps.vars.outputs.ghcr_image }}
      dockerhub_image: ${{ steps.vars.outputs.dockerhub_image }}
      build_time: ${{ steps.vars.outputs.build_time }}
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Validate Docker Hub HTTP+HTTPS stack compose file
        shell: bash
        run: |
          set -euo pipefail
          IMM_IMAGE=ohmzii/immaculaterr IMM_TAG=latest \
            docker compose -f docker/immaculaterr/docker-compose.dockerhub.yml config >/dev/null

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub (optional)
        if: ${{ env.DOCKERHUB_TOKEN != '' && env.DOCKERHUB_USERNAME != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Compute tags
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          VERSION="$(
            node -e "const fs=require('fs');const s=fs.readFileSync('apps/api/src/version.ts','utf8');const m=s.match(/APP_VERSION\\s*=\\s*'([^']+)'/);process.stdout.write((m&&m[1]?m[1].trim():'')||'0.0.0.0')"
          )"

          OWNER_LC="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          GHCR_IMAGE="ghcr.io/${OWNER_LC}/immaculaterr"
          DOCKERHUB_IMAGE="docker.io/ohmzii/immaculaterr"
          BUILD_TIME="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

          {
            echo "version=${VERSION}"
            echo "ghcr_image=${GHCR_IMAGE}"
            echo "dockerhub_image=${DOCKERHUB_IMAGE}"
            echo "build_time=${BUILD_TIME}"

            echo "tags<<EOF"
            echo "${GHCR_IMAGE}:latest"
            echo "${GHCR_IMAGE}:${VERSION}"
            echo "${GHCR_IMAGE}:v${VERSION}"
            if [[ -n "${DOCKERHUB_TOKEN:-}" && -n "${DOCKERHUB_USERNAME:-}" ]]; then
              echo "${DOCKERHUB_IMAGE}:latest"
              echo "${DOCKERHUB_IMAGE}:v${VERSION}"
            fi
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"
        env:
          DOCKERHUB_USERNAME: ${{ env.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ env.DOCKERHUB_TOKEN }}

      - name: Build and push (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/immaculaterr/Dockerfile
          pull: true
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.vars.outputs.tags }}
          labels: |
            org.opencontainers.image.title=Immaculaterr
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.event.pull_request.merge_commit_sha }}
            org.opencontainers.image.version=${{ steps.vars.outputs.version }}
            org.opencontainers.image.created=${{ steps.vars.outputs.build_time }}
          build-args: |
            APP_VERSION=${{ steps.vars.outputs.version }}
            APP_BUILD_SHA=${{ github.event.pull_request.merge_commit_sha }}
            APP_BUILD_TIME=${{ steps.vars.outputs.build_time }}

  create-release:
    name: Create GitHub release
    needs:
      - build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout merge commit (with tags)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          fetch-depth: 0

      - name: Prepare release notes (custom format)
        shell: bash
        env:
          VERSION: ${{ needs.build-and-push.outputs.version }}
          REPO: ${{ github.repository }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          PREV_TAG="$(
            {
              git tag --list 'v*' --sort=-version:refname \
                | grep -Fxv "v${VERSION}" \
                | head -n 1
            } || true
          )"

          CHANGES_FILE="$(mktemp)"
          if [ -n "${PR_BODY:-}" ]; then
            printf '%s\n' "${PR_BODY}" \
              | sed 's/\r$//' \
              | awk '/^[-*] / { print }' > "${CHANGES_FILE}" || true
          fi

          if [ ! -s "${CHANGES_FILE}" ]; then
            {
              echo "- ${PR_TITLE}"
              echo "- Merged pull request [#${PR_NUMBER}](https://github.com/${REPO}/pull/${PR_NUMBER})"
            } > "${CHANGES_FILE}"
          fi

          if [ -n "${PREV_TAG}" ]; then
            CHANGELOG_URL="https://github.com/${REPO}/compare/${PREV_TAG}..v${VERSION}"
          else
            CHANGELOG_URL="https://github.com/${REPO}/releases/tag/v${VERSION}"
          fi

          cat > RELEASE_NOTES.md <<EOF
          ## What's Changed
          $(cat "${CHANGES_FILE}")

          **Full Changelog**: ${CHANGELOG_URL}

          ## Updating

          ### Docker

          HTTP-only update (required)

          \`\`\`bash
          docker pull ohmzii/immaculaterr:v${VERSION}

          docker rm -f Immaculaterr 2>/dev/null || true

          docker run -d \
            --name Immaculaterr \
            --network host \
            -e HOST=0.0.0.0 \
            -e PORT=5454 \
            -e APP_DATA_DIR=/data \
            -e DATABASE_URL=file:/data/tcp.sqlite \
            -v immaculaterr-data:/data \
            --restart unless-stopped \
            ohmzii/immaculaterr:v${VERSION}
          \`\`\`

          Optional HTTPS sidecar (can run anytime later)

          \`\`\`bash
          mkdir -p ~/immaculaterr
          curl -fsSL -o ~/immaculaterr/caddy-entrypoint.sh \
            "https://raw.githubusercontent.com/ohmzi/Immaculaterr/v${VERSION}/docker/immaculaterr/caddy-entrypoint.sh"
          chmod +x ~/immaculaterr/caddy-entrypoint.sh

          docker pull caddy:2.8.4-alpine
          docker rm -f ImmaculaterrHttps 2>/dev/null || true

          docker run -d \
            --name ImmaculaterrHttps \
            --network host \
            -e IMM_ENABLE_HTTP=false \
            -e IMM_ENABLE_HTTPS=true \
            -e IMM_HTTPS_PORT=5464 \
            -e IMM_INCLUDE_LOCALHOST=true \
            -e IMM_ENABLE_LAN_IP=true \
            -e APP_INTERNAL_PORT=5454 \
            -v ~/immaculaterr/caddy-entrypoint.sh:/etc/caddy/caddy-entrypoint.sh:ro \
            -v immaculaterr-caddy-data:/data \
            -v immaculaterr-caddy-config:/config \
            --restart unless-stopped \
            caddy:2.8.4-alpine \
            /bin/sh /etc/caddy/caddy-entrypoint.sh
          \`\`\`

          ### Portainer

          1. In Portainer: **Containers** â†’ select **Immaculaterr**
          2. Click **Recreate**
          3. Enable **Re-pull image**
          4. Click **Recreate**
          EOF

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build-and-push.outputs.version }}
          target_commitish: ${{ github.event.pull_request.merge_commit_sha }}
          name: Release v${{ needs.build-and-push.outputs.version }}
          body_path: RELEASE_NOTES.md
          generate_release_notes: false
          make_latest: true
