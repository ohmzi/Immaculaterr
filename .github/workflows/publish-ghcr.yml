name: Publish Docker image to GHCR

on:
  push:
    branches:
      - master

permissions:
  contents: read
  packages: write

concurrency:
  group: ghcr-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image tags
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          # Read the in-app version from source of truth (apps/api/src/app.meta.ts).
          # This ensures the Docker image metadata matches what the app reports.
          VERSION="$(
            node -e "const fs=require('fs');const s=fs.readFileSync('apps/api/src/app.meta.ts','utf8');const m=s.match(/DEFAULT_APP_VERSION\\s*=\\s*'([^']+)'/);process.stdout.write((m&&m[1]?m[1].trim():'')||'0.0.0.0')"
          )"
          OWNER_LC="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          IMAGE="ghcr.io/${OWNER_LC}/immaculaterr"
          BUILD_TIME="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-12)"

          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "image=${IMAGE}" >> "${GITHUB_OUTPUT}"
          echo "build_time=${BUILD_TIME}" >> "${GITHUB_OUTPUT}"
          echo "short_sha=${SHORT_SHA}" >> "${GITHUB_OUTPUT}"

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/immaculaterr/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ steps.vars.outputs.image }}:latest
          labels: |
            org.opencontainers.image.title=immaculaterr
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ steps.vars.outputs.version }}
            org.opencontainers.image.created=${{ steps.vars.outputs.build_time }}
          build-args: |
            APP_VERSION=${{ steps.vars.outputs.version }}
            APP_BUILD_SHA=${{ github.sha }}
            APP_BUILD_TIME=${{ steps.vars.outputs.build_time }}

      - name: Tag version aliases (vX + X)
        shell: bash
        run: |
          set -euo pipefail

          IMAGE="${{ steps.vars.outputs.image }}"
          VERSION="${{ steps.vars.outputs.version }}"
          DIGEST="${{ steps.build.outputs.digest }}"

          if [[ -z "${DIGEST}" ]]; then
            echo "ERROR: build-push-action did not expose an image digest."
            exit 1
          fi

          echo "Tagging ${IMAGE}@${DIGEST} as ${IMAGE}:${VERSION} and ${IMAGE}:v${VERSION}"
          docker buildx imagetools create \
            --tag "${IMAGE}:${VERSION}" \
            --tag "${IMAGE}:v${VERSION}" \
            "${IMAGE}@${DIGEST}"
