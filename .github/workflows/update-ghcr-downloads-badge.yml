name: Update GHCR downloads badge

on:
  schedule:
    # Update periodically (GitHub schedules may be delayed)
    - cron: '17 * * * *'
  workflow_dispatch: {}

permissions:
  contents: write
  packages: read

concurrency:
  group: ghcr-downloads-badge
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Fetch GHCR downloads count (total)
        id: downloads
        env:
          OWNER: ohmzi
          REPO: Immaculaterr
          PACKAGE: immaculaterr
        shell: bash
        run: |
          set -euo pipefail

          # GitHub Packages downloads are shown on the package page but aren't reliably exposed via
          # the Packages REST API for container images. Scrape the public package page instead.
          total="$(
            curl -fsSL "https://github.com/${OWNER}/${REPO}/pkgs/container/${PACKAGE}" | \
              python3 - <<'PY'
import re, sys
html = sys.stdin.read()

# Example snippet:
#   <span ...>Total downloads</span>
#   <h3 title="264">264</h3>
m = re.search(r'Total downloads</span>\\s*<h3[^>]*title=\"([0-9,]+)\"', html, re.IGNORECASE)
if not m:
  m = re.search(r'Total downloads</span>\\s*<h3[^>]*>\\s*([0-9,]+)\\s*<', html, re.IGNORECASE)

print((m.group(1) if m else '0').replace(',', ''))
PY
          )"

          echo "total=${total}" >> "${GITHUB_OUTPUT}"

      - name: Write badge JSON
        env:
          TOTAL: ${{ steps.downloads.outputs.total }}
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p doc/assets/badges
          cat > doc/assets/badges/ghcr-downloads.json <<JSON
          {
            "schemaVersion": 1,
            "label": "GHCR downloads",
            "message": "${TOTAL}",
            "color": "blue"
          }
          JSON

      - name: Commit and push (if changed)
        shell: bash
        run: |
          set -euo pipefail

          if git diff --quiet -- doc/assets/badges/ghcr-downloads.json; then
            echo "No changes."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add doc/assets/badges/ghcr-downloads.json
          git commit -m "chore: update GHCR downloads badge"
          git push origin HEAD:develop

